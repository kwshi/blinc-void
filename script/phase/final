# vi: ft=bash
# shellcheck shell=bash

function build {
  local name mnt ctr
  local -a xdg symlinks dirs etc sv paths

  buildah run "$1" -- rm -rf \
    '/etc/iwd' \
    '/etc/sudoers.d' \
    '/etc/containers' \
    '/etc/lightdm/lightdm.conf' \
    '/etc/pulse/daemon.conf'

  buildah copy \
    --contextdir "$ROOT_DIR" \
    --ignorefile "$ROOT_DIR/.dockerignore" \
    "$1" "$ROOT_DIR" '/usr/share/blinc'

  log 'copying config paths'
  readarray -t paths < <(find "$ROOT_DIR/cfg" -type 'f' -printf '%P\n')
  for path in "${paths[@]}"; do
    log "copying ${path@Q}"
    buildah run "$1" -- mkdir -p "/${path%/*}"
    buildah run "$1" -- ln -sf "/usr/share/blinc/cfg/$path" "/$path"
  done

  # steam fonts patch, because ??????
  buildah run "$1" -- rm '/usr/share/fonts/steam-fonts/.uuid'
  buildah run "$1" -- mv '/usr/share/fonts/steam-fonts' '/usr/share/fonts/steam-bargage'

  buildah run "$1" -- chown -R 'root:root' '/etc/sudoers.d'

  buildah run "$1" -- ln -sT \
    '/usr/share/zoneinfo/America/Los_Angeles' '/etc/localtime'
  buildah run "$1" -- ln -st \
    '/etc/fonts/conf.d' '/usr/share/fontconfig/conf.avail/70-no-bitmaps.conf'
  buildah run "$1" -- ln -sT '/data/containers/root' '/var/lib/containers'
  buildah run "$1" -- ln -sT '/data/containers/docker' '/var/lib/docker'

  buildah run "$1" -- xbps-alternatives -s 'pinentry-gtk'

  sv=(
    'dbus'
    'docker'
    'iwd'
    'lightdm'
    'bluetoothd'
    'chronyd'

    'cupsd'

    # logging
    'socklog-unix'
    'nanoklogd'
  )

  for (( i=0; i<${#sv[@]}; ++i )); do
    sv[i]="/etc/sv/${sv[i]}"
  done

  buildah run "$1" -- ln -st '/etc/runit/runsvdir/default' "${sv[@]}"
  buildah run "$1" -- mkdir '/data' '/efi'

  buildah run "$1" -- groupadd -r 'autologin'
  buildah run "$1" -- usermod -aG 'docker,audio,video,autologin,socklog' 'kshi'

  log "running user config scripts"
  buildah config --workingdir '/home/kshi' -u 'kshi' "$1"

  log 'creating dirs'
  dirs=(
    .cache
    .config/gh
    .mozilla
    .local/share
    .xournal
  )

  buildah run "$1" mkdir -p "${dirs[@]}"
  buildah run "$1" rm '.bashrc' '.bash_profile'

  log 'symlinks'
  buildah run "$1" ln -st '.' \
    '/data/downloads' \
    '/data/dotfiles' \
    '/data/documents' \
    '/data/hacks' \
    '/data/movies' \
    '/data/blinc'

  symlinks=(
    '.mozilla/firefox' '/data/browser/firefox'
    '.config/chromium' '/data/browser/chromium'

    '.zoom'                     '/data/zoom'
    '.gnupg'                    '/data/gnupg'
    '.password-store'           '/data/pass'
    '.klei'                     '/data/games/klei'
    '.multimc'                  '/data/games/multimc'
    '.steam'                    '/data/games/steam/home'
    '.Mathematica'              '/data/mathematica'
    '.local/share/Steam'        '/data/games/steam/share'
    '.local/share/UnrailedGame' '/data/games/unrailed'
    '.config/unity3d'           '/data/games/unity3d'
    '.local/share/containers'   '/data/containers/kshi'
    '.cache/Tectonic'           '/data/tectonic'

    '.config/gh/hosts.yml' '/data/github/hosts.yml'
    '.config/spotifyd'     '/data/spotify/daemon'
    '.config/spotify-tui'  '/data/spotify/tui'
    '.config/spotify'      '/data/spotify/desktop'
    '.config/Signal'       '/data/signal'
    '.config/Slack'        '/data/slack'
    '.config/tentactl'     '/data/tentactl'
  )

  log 'more symlinks'
  for (( i=0; i<${#symlinks[@]}; i+=2 )); do
    buildah run "$1" -- ln -sT "${symlinks[i+1]}" "${symlinks[i]}"
  done

  log 'xdg symlinks'
  paths=(
    cli/git
    cli/bat
    cli/pip
    cli/nvim
    cli/emacs
    desk/alacritty
    desk/picom
    desk/polybar
    desk/bspwm
    desk/sxhkd
    desk/autorandr
    desk/rofi
  )
  xdg=()
  for path in "${paths[@]}"; do
    xdg+=("/home/kshi/dotfiles/$path")
  done

  buildah run "$1" ln -st '.config' "${xdg[@]}"

  buildah run "$1" ln -sT '/home/kshi/dotfiles/cli/ssh' '.ssh'
  buildah run "$1" ln -sT '/home/kshi/dotfiles/cli/pass-git' '.config/pass-git-helper'
  buildah run "$1" ln -sT '/home/kshi/dotfiles/cli/bash/rc' '.bashrc'
  buildah run "$1" ln -sT '/home/kshi/dotfiles/cli/bash/profile' '.bash_profile'
  buildah run "$1" ln -sT '/home/kshi/dotfiles/desk/xournal/config' '.xournal/config'
  buildah run "$1" ln -sT '/home/kshi/dotfiles/desk/conky/rc' '.conkyrc'

  buildah run "$1" xdg-user-dirs-update
}

run-phase-img 'final' build 'home'
