# vi: ft=bash
# shellcheck shell=bash

#function build {

  local name mnt ctr
  local -a xdg symlinks dirs etc sv paths

log-phase 'img/final'

if newer-deps 'final' -i 'home'; then

  ctr=$(from 'final' "$BUILDAH_NAME_PREFIX/home")

  buildah run "$ctr" -- rm -rf \
    '/etc/iwd' \
    '/etc/sudoers.d' \
    '/etc/containers' \
    '/etc/lightdm/lightdm.conf' \
    '/etc/pulse/daemon.conf'

  # copy latest configuration files from current repo to bootstrap (most other
  # files will be overridden @ boot time, when /etc/fstab bind-mounts this
  # directory)
  buildah copy -q \
    --contextdir "$ROOT_DIR" \
    --ignorefile "$ROOT_DIR/.dockerignore" \
    "$ctr" "$ROOT_DIR" '/usr/share/blinc'

  # copy dbus machine-id to persist it across reinstalls (attempt to convince
  # mathematica the machine hasn't changed)
  buildah copy -q "$ctr" '/var/lib/dbus/machine-id' '/var/lib/dbus/machine-id'

  log 'copying config paths'
  readarray -t paths < <(find "$ROOT_DIR/cfg" -type 'f' -printf '%P\n')
  for path in "${paths[@]}"; do
    log "copying ${path@Q}"
    buildah run "$ctr" -- mkdir -p "/${path%/*}"
    buildah run "$ctr" -- ln -sf "/usr/share/blinc/cfg/$path" "/$path"
  done

  # steam fonts patch, because ??????
  #buildah run "$ctr" -- rm '/usr/share/fonts/steam-fonts/.uuid'
  #buildah run "$ctr" -- mv '/usr/share/fonts/steam-fonts' '/usr/share/fonts/steam-bargage'

  buildah run "$ctr" -- chown -R 'root:root' '/etc/sudoers.d'

  buildah run "$ctr" -- ln -sT \
    '/usr/share/zoneinfo/America/Los_Angeles' '/etc/localtime'
  buildah run "$ctr" -- ln -st \
    '/etc/fonts/conf.d' '/usr/share/fontconfig/conf.avail/70-no-bitmaps.conf'
  buildah run "$ctr" -- ln -sT '/extra/containers/root' '/var/lib/containers'
  buildah run "$ctr" -- ln -sT '/extra/containers/docker' '/var/lib/docker'

  buildah run "$ctr" -- rmdir '/var/lib/iwd'
  buildah run "$ctr" -- ln -sT '/data/iwd' '/var/lib/iwd'

  buildah run "$ctr" -- ln -sT '/data/connman' '/var/lib/connman'

  buildah run "$ctr" -- xbps-alternatives -s 'pinentry-gtk'

  sv=(
    'dbus'
    'docker'
    # 'iwd'
    'connmand'
    'lightdm'
    'bluetoothd'
    'chronyd'

    'cupsd'

    # logging
    'socklog-unix'
    'nanoklogd'

    # android debugger server
    'adb'
  )

  for (( i=0; i<${#sv[@]}; ++i )); do
    sv[i]="/etc/sv/${sv[i]}"
  done

  buildah run "$ctr" -- ln -st '/etc/runit/runsvdir/default' "${sv[@]}"
  buildah run "$ctr" -- mkdir '/data' '/efi' '/extra'

  buildah run "$ctr" -- groupadd -r 'autologin'
  buildah run "$ctr" -- usermod -aG 'docker,audio,video,autologin,socklog,dialout,optical,cdrom' 'kshi'

  log "running user config scripts"
  buildah config --workingdir '/home/kshi' -u 'kshi' "$ctr"

  log 'creating dirs'
  dirs=(
    .cache
    .config/gh
    .mozilla
    .local/share
    .xournal
  )

  buildah run "$ctr" mkdir -p "${dirs[@]}"
  buildah run "$ctr" rm '.bashrc' '.bash_profile'

  log 'symlinks'
  buildah run "$ctr" ln -st '.' \
    '/data/dotfiles' \
    '/data/documents' \
    '/data/hacks' \
    '/extra/downloads' \
    '/extra/pictures' \
    '/extra/media' \
    '/extra/blinc'

  symlinks=(
    '.mozilla/firefox' '/data/browser/firefox'
    '.config/chromium' '/data/browser/chromium'

    '.gnupg'                       '/data/gnupg'
    '.password-store'              '/data/pass'
    '.Mathematica'                 '/data/mathematica'
    '.cache/Tectonic'              '/data/tectonic'
    '.local/share/zathura'         '/data/zathura'
    '.local/share/TelegramDesktop' '/data/social/telegram'
    '.klei'                        '/extra/games/klei'
    '.multimc'                     '/extra/games/multimc'
    '.minecraft'                   '/extra/games/minecraft'
    '.steam'                       '/extra/games/steam/home'
    '.local/share/Steam'           '/extra/games/steam/share'
    '.local/share/UnrailedGame'    '/extra/games/unrailed'
    '.config/unity3d'              '/extra/games/unity3d'
    '.local/share/containers'      '/extra/containers/kshi'

    '.netrc' '/data/login/netrc'

    '.config/gh/hosts.yml' '/data/github/hosts.yml'
    '.config/spotifyd'     '/data/spotify/daemon'
    '.config/spotify-tui'  '/data/spotify/tui'
    '.config/spotify'      '/data/spotify/desktop'
    '.config/Signal'       '/data/social/signal'
    '.config/Slack'        '/data/social/slack'
    '.config/discord'      '/data/social/discord'
    '.zoom'                '/data/social/zoom'
    '.config/rmapi'        '/data/rmapi'
    '.config/rmcl'         '/data/rmcl'
    '.config/tentactl'     '/data/tentactl'
  )

  log 'more symlinks'
  for (( i=0; i<${#symlinks[@]}; i+=2 )); do
    buildah run "$ctr" -- ln -sT "${symlinks[i+1]}" "${symlinks[i]}"
  done

  log 'xdg symlinks'
  paths=(
    cli/git
    cli/bat
    cli/pip
    cli/nvim
    cli/emacs
    cli/pgcli
    cli/glow
    cli/ranger
    desk/kitty
    desk/alacritty
    desk/wezterm
    desk/picom
    desk/polybar
    desk/bspwm
    desk/sxhkd
    desk/autorandr
    desk/rofi
    desk/conky
    desk/zathura
    desk/xdg
    desk/mpv
  )
  xdg=()
  for path in "${paths[@]}"; do
    xdg+=("/home/kshi/dotfiles/$path")
  done

  buildah run "$ctr" ln -st '.config' "${xdg[@]}"

  buildah run "$ctr" mkdir -p '.ipython/profile_default'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/ssh' '.ssh'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/jupyter' '.jupyter'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/ipython/startup' '.ipython/profile_default/startup'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/pass-git' '.config/pass-git-helper'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/bash/rc' '.bashrc'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/bash/profile' '.bash_profile'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/cargo/config.toml' '.cargo/config.toml'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/starship/starship.toml' '.config/starship.toml'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/cli/openscad' '.config/OpenSCAD'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/desk/xournal/config' '.xournal/config'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/desk/xprofile' '.xprofile'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/desk/fcitx/config' '.config/fcitx5'

  buildah run "$ctr" -- mkdir -p '.local/share/fcitx5'
  buildah run "$ctr" ln -sT '/home/kshi/dotfiles/desk/fcitx/theme' '.local/share/fcitx5/themes'

  buildah run "$ctr" xdg-user-dirs-update

  commit 'final' "$ctr"

fi

log-done 'img/final'

#}

#run-phase-img 'final' build 'home'
